<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Connexion — Prix Agricoles</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <main class="container">
    <h2>Connexion / Inscription</h2>
    <form id="loginForm">
      <label>Email<input type="email" id="email" required></label>
      <label>Mot de passe<input type="password" id="password" required></label>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button type="submit">Se connecter</button>
        <button type="button" id="btnRegister">S'inscrire</button>
      </div>
    </form>
    <div id="msg" role="status" aria-live="polite" style="margin-top:1rem"></div>
  </main>

  <script>
    async function postJSON(url, body){
      const res = await fetch(url, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
      return res;
    }

    document.getElementById('loginForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const email = document.getElementById('email').value;
      const motDePasse = document.getElementById('password').value;
      try{
        const r = await postJSON('/api/auth/login',{email,motDePasse});
        if(!r.ok) throw new Error('Identifiants invalides');
        const body = await r.json();
        localStorage.setItem('token', body.token);
        document.getElementById('msg').textContent = 'Connecté';
        setTimeout(()=> location.href = 'index.html', 800);
      }catch(err){document.getElementById('msg').textContent = err.message}
    });

    document.getElementById('btnRegister').addEventListener('click', async ()=>{
      const email = document.getElementById('email').value;
      const motDePasse = document.getElementById('password').value;
      if(!email || !motDePasse) return alert('Remplir email et mot de passe');
      try{
        const r = await postJSON('/api/auth/register',{nom:email.split('@')[0], email, motDePasse});
        if(!r.ok){ const t = await r.text(); throw new Error(t);} 
        const body = await r.json();
        localStorage.setItem('token', body.token);
        document.getElementById('msg').textContent = 'Inscription réussie';
        setTimeout(()=> location.href = 'index.html', 800);
      }catch(err){document.getElementById('msg').textContent = err.message}
    });
  </script>
</body>
</html>
